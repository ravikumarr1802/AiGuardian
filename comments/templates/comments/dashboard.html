<!DOCTYPE html>
<html>
  <head>
    <title>AiGuardian Dashboard</title>
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <style>
      body {
        background: #f9f9f9;
      }
      .card-video-frame {
        position: relative;
        width: 100%;
        height: 2.1cm;
        border-radius: 3px;
        overflow: hidden; /* ensure iframe never exceeds the card */
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        background: #000;
      }
      .card-video-frame iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
      }
      .yt-card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
      }
      .yt-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #eee;
        display: inline-block;
      }
      .yt-header {
        background: #fff;
        color: #ff0000;
        padding: 20px;
        border-radius: 8px 8px 0 0;
        border: 2px solid #ff0000;
      }
      .yt-btn {
        background: #ff0000;
        color: #fff;
        border: none;
      }
      .action-btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .action-btn-group form,
      .action-btn-group a {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div
        class="yt-header mb-4 d-flex justify-content-between align-items-center"
      >
        <div class="d-flex align-items-center">
          <img
            src="/media/youtube_logo.jpeg"
            height="40"
            style="vertical-align: middle"
            alt="YouTube Logo"
          />
          <span class="h4 ml-2">AiGuardian Dashboard</span>
          <!-- Home icon button 1cm x 1cm to the right of AiGuardian text -->
          <a
            href="/"
            class="ml-3 d-flex align-items-center justify-content-center"
            title="Home"
            aria-label="Home"
            style="width: 1cm; height: 1cm; border-radius: 6px"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="#d32f2f"
            >
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
          </a>
        </div>
        <div class="d-flex align-items-center">
          <a
            href="{% url 'log_analytics' %}{% if current_video_id %}?video_id={{ current_video_id }}{% endif %}"
            class="btn mr-2"
            style="
              font-size: 0.85rem;
              padding: 6px 16px;
              font-weight: bold;
              min-width: 120px;
              background-color: #17a2b8;
              color: #fff;
              border-color: #17a2b8;
            "
          >
            Log Analytics
          </a>
          <a
            href="https://colab.research.google.com/drive/1XbKigGFhxiuc46GorxfN88NVtlvH_xV_?usp=sharing"
            class="btn mr-2"
            style="
              font-size: 0.85rem;
              padding: 6px 16px;
              font-weight: bold;
              min-width: 120px;
              background-color: #ff9800;
              color: #fff;
              border-color: #ff9800;
            "
            target="_blank"
            >Model Performance</a
          >
          <form
            method="post"
            action="{% url 'fetch_all_comments' %}"
            style="margin-bottom: 0"
          >
            {% csrf_token %}
            <input
              type="hidden"
              name="current_video_id"
              value="{{ current_video_id }}"
            />
            <button
              type="submit"
              class="btn"
              style="
                background-color: #4caf50;
                color: #fff;
                font-size: 0.85rem;
                font-weight: bold;
                padding: 6px 16px;
                min-width: 120px;
                border-color: #4caf50;
              "
            >
              Fetch Comments
            </button>
          </form>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col">
          <div class="card text-center">
            <div class="card-body">
              <h5>Total Comments</h5>
              <p class="h2">{{ stats.total }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card text-center">
            <div class="card-body">
              <h5>Review</h5>
              <p class="h2">{{ stats.review }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card text-center">
            <div class="card-body">
              <h5>Neutral</h5>
              <p class="h2">{{ stats.neutral }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card text-center">
            <div class="card-body">
              <h5>Deleted / Toxic</h5>
              <p class="h2">{{ stats.deleted }}</p>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card text-center">
            <div class="card-body">
              <div class="card-video-frame">
                {% if current_video_id %}
                <div id="yt-player-container">
                  <!-- The player will be created here by the YouTube IFrame API -->
                  <div id="yt-player" style="width: 100%; height: 100%"></div>
                  <!-- Fallback shown when embedding is blocked or an error occurs -->
                  <div
                    id="yt-fallback"
                    style="display: none; padding: 12px; color: #666"
                  >
                    <p>
                      This video cannot be embedded.
                      <a
                        id="yt-open-link"
                        href="https://www.youtube.com/watch?v={{ current_video_id }}"
                        target="_blank"
                        rel="noopener"
                        >Open on YouTube</a
                      >
                    </p>
                    <img
                      id="yt-thumb"
                      src="https://img.youtube.com/vi/{{ current_video_id }}/hqdefault.jpg"
                      alt="thumbnail"
                      style="
                        max-width: 100%;
                        margin-top: 8px;
                        border-radius: 4px;
                      "
                    />
                  </div>
                </div>
                {% else %}
                <div class="text-muted">No video selected</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <ul class="nav nav-tabs" id="commentTabs" role="tablist">
        <li class="nav-item">
          <a
            class="nav-link active"
            id="review-tab"
            data-toggle="tab"
            href="#review"
            role="tab"
            aria-controls="review"
            aria-selected="true"
            >Review</a
          >
        </li>
        <li class="nav-item">
          <a
            class="nav-link"
            id="neutral-tab"
            data-toggle="tab"
            href="#neutral"
            role="tab"
            aria-controls="neutral"
            aria-selected="false"
            >Neutral</a
          >
        </li>
        <li class="nav-item d-flex align-items-center">
          <a
            class="nav-link"
            id="deleted-tab"
            data-toggle="tab"
            href="#deleted"
            role="tab"
            aria-controls="deleted"
            aria-selected="false"
            >Deleted</a
          >
          <span style="color: #2f58d3; font-weight: 700; margin-left: 12px"
            >{{ current_video_name }}</span
          >
        </li>
      </ul>
      <div class="tab-content mt-3" id="commentTabsContent">
        <!-- Review Tab -->
        <div
          class="tab-pane fade show active"
          id="review"
          role="tabpanel"
          aria-labelledby="review-tab"
        >
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Comment ID</th>
                  <th>Author</th>
                  <th>Text</th>
                  <th>Likes</th>
                  <th>Published At</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in review_comments %}
                <tr>
                  <td>{{ comment.comment_id }}</td>
                  <td>{{ comment.author }}</td>
                  <td>{{ comment.text }}</td>
                  <td>{{ comment.like_count }}</td>
                  <td>{{ comment.published_at }}</td>
                  <td>{{ comment.moderation_status }}</td>
                  <td>
                    <div class="action-btn-group">
                      <button
                        type="button"
                        class="btn btn-success btn-sm"
                        data-toggle="modal"
                        data-target="#neutralModal"
                        data-comment-id="{{ comment.comment_id }}"
                        data-comment-text="{{ comment.text }}"
                      >
                        Move to Neutral
                      </button>
                      <!-- Neutral Modal -->
                      <div
                        class="modal fade"
                        id="neutralModal"
                        tabindex="-1"
                        role="dialog"
                        aria-labelledby="neutralModalLabel"
                        aria-hidden="true"
                      >
                        <div class="modal-dialog" role="document">
                          <div class="modal-content">
                            <form id="neutralForm">
                              <div class="modal-header">
                                <h5 class="modal-title" id="neutralModalLabel">
                                  Mark as Neutral
                                </h5>
                                <button
                                  type="button"
                                  class="close"
                                  data-dismiss="modal"
                                  aria-label="Close"
                                >
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <input
                                  type="hidden"
                                  id="neutralCommentId"
                                  name="comment_id"
                                />
                                <div class="form-group">
                                  <label for="neutralLanguage"
                                    >Language Type</label
                                  >
                                  <select
                                    class="form-control"
                                    id="neutralLanguage"
                                    name="language_type"
                                    required
                                  >
                                    <option value="">Select Language</option>
                                    <option value="Telugu">Telugu</option>
                                    <option value="English">English</option>
                                    <option value="Hybrid">Hybrid</option>
                                  </select>
                                </div>
                                <div class="form-group">
                                  <label for="neutralToxicWord"
                                    >Toxic Word</label
                                  >
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="neutralToxicWord"
                                    name="toxic_word"
                                    value="NULL"
                                    readonly
                                  />
                                </div>
                                <div class="form-group">
                                  <label for="neutralContext">Context</label>
                                  <textarea
                                    class="form-control"
                                    id="neutralContext"
                                    name="context"
                                    rows="3"
                                    readonly
                                  ></textarea>
                                </div>
                                <div class="form-group">
                                  <label for="neutralCategory"
                                    >Category of Toxicity</label
                                  >
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="neutralCategory"
                                    name="toxicity_category"
                                    value="Neutral"
                                    readonly
                                  />
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button
                                  type="button"
                                  class="btn btn-secondary"
                                  data-dismiss="modal"
                                >
                                  Cancel
                                </button>
                                <button type="submit" class="btn btn-success">
                                  Mark as Neutral & Queue for Retraining
                                </button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        data-toggle="modal"
                        data-target="#reclassifyModal"
                        data-comment-id="{{ comment.comment_id }}"
                        data-comment-text="{{ comment.text }}"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="7">No review comments.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- Neutral Tab -->
        <div
          class="tab-pane fade"
          id="neutral"
          role="tabpanel"
          aria-labelledby="neutral-tab"
        >
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Comment ID</th>
                  <th>Author</th>
                  <th>Text</th>
                  <th>Likes</th>
                  <th>Published At</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in neutral_comments %}
                <tr>
                  <td>{{ comment.comment_id }}</td>
                  <td>{{ comment.author }}</td>
                  <td>{{ comment.text }}</td>
                  <td>{{ comment.like_count }}</td>
                  <td>{{ comment.published_at }}</td>
                  <td>{{ comment.moderation_status }}</td>
                  <td>
                    <div class="action-btn-group">
                      <button
                        type="button"
                        class="btn btn-danger btn-sm"
                        data-toggle="modal"
                        data-target="#reclassifyModal"
                        data-comment-id="{{ comment.comment_id }}"
                        data-comment-text="{{ comment.text }}"
                      >
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">No neutral comments.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
        <!-- Deleted Tab -->
        <div
          class="tab-pane fade"
          id="deleted"
          role="tabpanel"
          aria-labelledby="deleted-tab"
        >
          <div class="table-responsive">
            <table class="table table-bordered table-hover">
              <thead class="thead-light">
                <tr>
                  <th>Comment ID</th>
                  <th>Author</th>
                  <th>Text</th>
                  <th>Likes</th>
                  <th>Published At</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in deleted_comments %}
                <tr>
                  <td>{{ comment.comment_id }}</td>
                  <td>{{ comment.author }}</td>
                  <td class="text-danger">{{ comment.text }}</td>
                  <td>{{ comment.like_count }}</td>
                  <td>{{ comment.published_at }}</td>
                  <td>{{ comment.moderation_status }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="6">No deleted comments.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Reclassification Modal -->
      <div
        class="modal fade"
        id="reclassifyModal"
        tabindex="-1"
        role="dialog"
        aria-labelledby="reclassifyModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form id="reclassifyForm">
              <div class="modal-header">
                <h5 class="modal-title" id="reclassifyModalLabel">
                  Reclassify & Delete Comment
                </h5>
                <button
                  type="button"
                  class="close"
                  data-dismiss="modal"
                  aria-label="Close"
                >
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="modalCommentId" name="comment_id" />
                <div class="form-group">
                  <label for="modalLanguage">Language Type</label>
                  <select
                    class="form-control"
                    id="modalLanguage"
                    name="language_type"
                    required
                  >
                    <option value="">Select Language</option>
                    <option value="Telugu">Telugu</option>
                    <option value="English">English</option>
                    <option value="Hybrid">Hybrid</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="modalToxicWord"
                    >Toxic Word
                    <span class="text-muted" style="font-size: 12px"
                      >(Add Toxic word in the comment)</span
                    ></label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="modalToxicWord"
                    name="toxic_word"
                    placeholder="Enter toxic word from comment"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="modalContext">Context</label>
                  <textarea
                    class="form-control"
                    id="modalContext"
                    name="context"
                    rows="3"
                    readonly
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="modalCategory">Category of Toxicity</label>
                  <select
                    class="form-control"
                    id="modalCategory"
                    name="toxicity_category"
                    required
                  >
                    <option value="">Select Category</option>
                    <option value="Abusive / Insult">Abusive / Insult</option>
                    <option value="Harassment / Bullying">
                      Harassment / Bullying
                    </option>
                    <option value="Hate Speech">Hate Speech</option>
                    <option value="Other">Other</option>
                    <option value="Sexual / Obscene">Sexual / Obscene</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-danger">
                  Delete & Queue for Retraining
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
      <!-- YouTube IFrame API -->
      <script src="https://www.youtube.com/iframe_api"></script>
      <script>
        // Create player when API is ready
        var ytPlayer = null;
        function onYouTubeIframeAPIReady() {
          var vid = "{{ current_video_id }}";
          if (!vid) return;
          ytPlayer = new YT.Player("yt-player", {
            height: "100%",
            width: "100%",
            videoId: vid,
            playerVars: {
              rel: 0,
              modestbranding: 1,
              playsinline: 1,
              autoplay: 1,
              mute: 1,
              controls: 0,
              loop: 1,
              playlist: vid,
            },
            events: {
              onReady: function (event) {
                try {
                  event.target.playVideo();
                } catch (e) {}
              },
              onError: function (event) {
                // Known embed-blocking error codes: 101, 150, 153
                var code = event.data;
                console.warn("YouTube player error", code);
                // Show fallback UI
                var container = document.getElementById("yt-player-container");
                var playerDiv = document.getElementById("yt-player");
                var fallback = document.getElementById("yt-fallback");
                if (playerDiv) playerDiv.style.display = "none";
                if (fallback) fallback.style.display = "block";
                var openLink = document.getElementById("yt-open-link");
                if (openLink)
                  openLink.href =
                    "https://www.youtube.com/watch?v={{ current_video_id }}";
              },
            },
          });
        }
        // If IFrame API doesn't load or player never initialized, show fallback after timeout
        setTimeout(function () {
          if (!ytPlayer) {
            var fallback = document.getElementById("yt-fallback");
            var playerDiv = document.getElementById("yt-player");
            if (playerDiv) playerDiv.style.display = "none";
            if (fallback) fallback.style.display = "block";
          }
        }, 5000);
      </script>
      <script>
        // Fill neutral modal with comment data
        $("#neutralModal").on("show.bs.modal", function (event) {
          var button = $(event.relatedTarget);
          var commentId = button.data("comment-id");
          var commentText = button.data("comment-text");
          $("#neutralCommentId").val(commentId);
          $("#neutralContext").val(commentText);
        });

        // Fill modal with comment data
        $("#reclassifyModal").on("show.bs.modal", function (event) {
          var button = $(event.relatedTarget);
          var commentId = button.data("comment-id");
          var commentText = button.data("comment-text");
          $("#modalCommentId").val(commentId);
          $("#modalContext").val(commentText); // context is auto-copied, not editable
        });

        // AJAX form submission for neutral
        $("#neutralForm").submit(function (e) {
          e.preventDefault();
          var formData = $(this).serialize();
          $.ajax({
            url: '{% url "neutral_and_queue" %}',
            type: "POST",
            data: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function (response) {
              $("#neutralModal").modal("hide");
              location.reload();
            },
            error: function (xhr) {
              alert("Error: " + xhr.responseText);
            },
          });
        });

        // AJAX form submission for delete
        $("#reclassifyForm").submit(function (e) {
          e.preventDefault();
          var formData = $(this).serialize();
          $.ajax({
            url: '{% url "reclassify_and_delete" %}',
            type: "POST",
            data: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function (response) {
              $("#reclassifyModal").modal("hide");
              // Optionally show a success message
              location.reload(); // Refresh to update dashboard
            },
            error: function (xhr) {
              alert("Error: " + xhr.responseText);
            },
          });
        });
      </script>
    </div>
  </body>
</html>
